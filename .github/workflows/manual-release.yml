name: æ‰‹åŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.26)'
        required: true
        type: string
      release_notes:
        description: 'æ›´æ–°è¯´æ˜ (æ”¯æŒ Markdown æ ¼å¼)'
        required: false
        type: string
        default: '- æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      draft:
        description: 'æ˜¯å¦åˆ›å»ºè‰ç¨¿å‘å¸ƒ'
        required: false
        type: boolean
        default: false
      platforms:
        description: 'æ„å»ºå¹³å° (å¤šé€‰ç”¨é€—å·åˆ†éš”: x64,Win32,ARM64)'
        required: false
        type: string
        default: 'x64,Win32,ARM64'

permissions:
  contents: write
  actions: read
  checks: read

env:
  BUILD_CONFIGURATION: Release
  PROJECT_NAME: TinyPin

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: éªŒè¯å’Œå¤„ç†è¾“å…¥å‚æ•°
        id: validate_inputs
        shell: pwsh
        run: |
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          $version = "${{ github.event.inputs.version }}"
          if ($version -notmatch '^\d+\.\d+\.\d+$') {
            Write-Error "ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º x.y.z æ ¼å¼ (ä¾‹å¦‚: 1.0.26)"
            exit 1
          }
          
          # å¤„ç†å¹³å°åˆ—è¡¨
          $platformsInput = "${{ github.event.inputs.platforms }}"
          $validPlatforms = @("x64", "Win32", "ARM64")
          $selectedPlatforms = $platformsInput -split ',' | ForEach-Object { $_.Trim() }
          
          foreach ($platform in $selectedPlatforms) {
            if ($platform -notin $validPlatforms) {
              Write-Error "æ— æ•ˆçš„å¹³å°: $platformã€‚æœ‰æ•ˆå¹³å°: $($validPlatforms -join ', ')"
              exit 1
            }
          }
          
          # è¾“å‡ºå¤„ç†åçš„å‚æ•°
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT
          echo "platforms=$($selectedPlatforms -join ',')" >> $env:GITHUB_OUTPUT
          
          Write-Host "âœ“ ç‰ˆæœ¬å·: $version"
          Write-Host "âœ“ æ„å»ºå¹³å°: $($selectedPlatforms -join ', ')"
          Write-Host "âœ“ é¢„å‘å¸ƒ: ${{ github.event.inputs.prerelease }}"
          Write-Host "âœ“ è‰ç¨¿: ${{ github.event.inputs.draft }}"

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        shell: pwsh
        run: |
          $tag = "${{ steps.validate_inputs.outputs.tag }}"
          
          # æ£€æŸ¥æœ¬åœ°æ ‡ç­¾
          $localTag = git tag -l $tag
          if ($localTag) {
            Write-Error "æ ‡ç­¾ $tag å·²åœ¨æœ¬åœ°å­˜åœ¨"
            exit 1
          }
          
          # æ£€æŸ¥è¿œç¨‹æ ‡ç­¾
          git fetch --tags
          $remoteTag = git ls-remote --tags origin $tag
          if ($remoteTag) {
            Write-Error "æ ‡ç­¾ $tag å·²åœ¨è¿œç¨‹ä»“åº“å­˜åœ¨"
            exit 1
          }
          
          Write-Host "âœ“ æ ‡ç­¾ $tag å¯ç”¨"

      - name: åˆ›å»ºæ„å»ºç›®å½•
        shell: pwsh
        run: |
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          
          foreach ($platform in $platforms) {
            $dir = "build/compile/Release/$platform"
            if (!(Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir -Force | Out-Null
            }
            Write-Host "âœ“ åˆ›å»ºç›®å½•: $dir"
          }
          
          if (!(Test-Path "build/installer")) {
            New-Item -ItemType Directory -Path "build/installer" -Force | Out-Null
          }
          Write-Host "âœ“ åˆ›å»ºç›®å½•: build/installer"

      - name: æ„å»ºæ‰€æœ‰å¹³å°
        shell: pwsh
        run: |
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          
          foreach ($platform in $platforms) {
            Write-Host "ğŸ”¨ æ„å»º $platform ç‰ˆæœ¬..."
            msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=$platform /p:OutDir="build\compile\Release\$platform\" /nologo /verbosity:minimal
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform ç‰ˆæœ¬æ„å»ºå¤±è´¥"
              exit 1
            }
            
            $exePath = "build\compile\Release\$platform\TinyPin.exe"
            if (!(Test-Path $exePath)) {
              Write-Error "$platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: $exePath"
              exit 1
            }
            
            Write-Host "âœ“ $platform ç‰ˆæœ¬æ„å»ºæˆåŠŸ"
          }

      - name: åˆ›å»ºå®‰è£…åŒ…
        shell: pwsh
        run: |
          $version = "${{ steps.validate_inputs.outputs.version }}"
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          $isccPath = "tools\InnoSetup6\ISCC.exe"
          $scriptPath = "tools\Scripts\TinyPin.iss"
          $outputDir = "build\installer"

          foreach ($platform in $platforms) {
            Write-Host "ğŸ“¦ åˆ›å»º $platform å®‰è£…åŒ…..."
            $sourcePath = "build\compile\Release\$platform\TinyPin.exe"
            $relativeSourcePath = "..\..\build\compile\Release\$platform\TinyPin.exe"
            
            if (!(Test-Path $sourcePath)) {
              Write-Error "æºæ–‡ä»¶ä¸å­˜åœ¨: $sourcePath"
              exit 1
            }
            
            $scriptOutputDir = "build\installer"
            & $isccPath $scriptPath /Dp=$platform /Ds=$relativeSourcePath /Do=$scriptOutputDir /Dv=$version
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
              exit 1
            }
            
            # ç§»åŠ¨å®‰è£…åŒ…åˆ°æœ€ç»ˆä½ç½®
            $possibleVersions = @($version, "1.0.0")
            $scriptInstallerPath = $null
            
            foreach ($testVersion in $possibleVersions) {
              $testPath = "tools\Scripts\$scriptOutputDir\TinyPin-$testVersion-$platform-setup.exe"
              if (Test-Path $testPath) {
                $scriptInstallerPath = $testPath
                break
              }
            }
            
            $finalInstallerPath = "$outputDir\TinyPin-$version-$platform-setup.exe"
            
            if ($scriptInstallerPath -and (Test-Path $scriptInstallerPath)) {
              $targetDir = Split-Path $finalInstallerPath -Parent
              if (!(Test-Path $targetDir)) {
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
              }
              Move-Item -Path $scriptInstallerPath -Destination $finalInstallerPath -Force
              
              if (!(Test-Path $finalInstallerPath)) {
                Write-Error "$platform å®‰è£…åŒ…ç§»åŠ¨å¤±è´¥"
                exit 1
              }
              
              Write-Host "âœ“ $platform å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ"
            } else {
              Write-Error "$platform å®‰è£…åŒ…æ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            }
          }

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.validate_inputs.outputs.version }}"
          $date = Get-Date -Format "yyyyå¹´MMæœˆddæ—¥"
          $tagName = "v$version"
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          $customNotes = @"
          ${{ github.event.inputs.release_notes }}
          "@
          
          # ç”Ÿæˆå®‰è£…åŒ…ä¸‹è½½åˆ—è¡¨
          $downloadList = ""
          foreach ($platform in $platforms) {
            $downloadList += "- **TinyPin-$version-$platform-setup.exe** - é€‚ç”¨äº "
            switch ($platform) {
              "x64" { $downloadList += "64 ä½ Windows ç³»ç»Ÿ" }
              "Win32" { $downloadList += "32 ä½å’Œ 64 ä½ Windows ç³»ç»Ÿ" }
              "ARM64" { $downloadList += "ARM64 Windows ç³»ç»Ÿ" }
            }
            $downloadList += "`n"
          }
          
          $releaseNotes = @"
          ## TinyPin $version å‘å¸ƒ
          
          **å‘å¸ƒæ—¥æœŸ**: $date
          **æ ‡ç­¾**: $tagName
          **å‘å¸ƒç±»å‹**: ${{ github.event.inputs.prerelease == 'true' && 'é¢„å‘å¸ƒ' || 'æ­£å¼å‘å¸ƒ' }}
          
          ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
          
          $downloadList
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          
          - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - å¯¹åº”çš„ç³»ç»Ÿæ¶æ„ (x64/x86/ARM64)
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          $customNotes
          
          ### ğŸš€ å®‰è£…è¯´æ˜
          
          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
          2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
          3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æ‰¾åˆ° TinyPin
          "@

          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
          echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT

      - name: éªŒè¯å®‰è£…åŒ…
        shell: pwsh
        run: |
          $version = "${{ steps.validate_inputs.outputs.version }}"
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          $allFilesExist = $true

          foreach ($platform in $platforms) {
            $installerPath = "build\installer\TinyPin-$version-$platform-setup.exe"
            if (!(Test-Path $installerPath)) {
              Write-Error "$platform å®‰è£…åŒ…ä¸å­˜åœ¨: $installerPath"
              $allFilesExist = $false
            } else {
              Write-Host "âœ“ $platform å®‰è£…åŒ…éªŒè¯é€šè¿‡"
            }
          }

          if (-not $allFilesExist) {
            Write-Error "éƒ¨åˆ†å®‰è£…åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º Release"
            exit 1
          }

      - name: åˆ›å»º Git æ ‡ç­¾
        shell: pwsh
        run: |
          $tag = "${{ steps.validate_inputs.outputs.tag }}"
          $version = "${{ steps.validate_inputs.outputs.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a $tag -m "Release $version"
          git push origin $tag
          
          Write-Host "âœ“ åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: $tag"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.validate_inputs.outputs.tag }}
          name: TinyPin ${{ steps.validate_inputs.outputs.version }}
          body_path: release_notes.md
          files: |
            build/installer/*.exe
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          fail_on_unmatched_files: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: TinyPin-${{ steps.validate_inputs.outputs.version }}-Installers-Manual
          path: |
            build/installer/*.exe
          retention-days: 30

      - name: å‘å¸ƒå®Œæˆé€šçŸ¥
        shell: pwsh
        run: |
          $version = "${{ steps.validate_inputs.outputs.version }}"
          $tag = "${{ steps.validate_inputs.outputs.tag }}"
          $platforms = "${{ steps.validate_inputs.outputs.platforms }}" -split ','
          
          Write-Host "ğŸ‰ TinyPin $version æ‰‹åŠ¨å‘å¸ƒå®Œæˆï¼"
          Write-Host ""
          Write-Host "ğŸ“¦ ç”Ÿæˆçš„å®‰è£…åŒ…ï¼š"
          foreach ($platform in $platforms) {
            $installerPath = "build\installer\TinyPin-$version-$platform-setup.exe"
            if (Test-Path $installerPath) {
              $size = [math]::Round((Get-Item $installerPath).Length/1MB, 2)
              Write-Host "  - TinyPin-$version-$platform-setup.exe ($size MB)"
            }
          }
          
          Write-Host ""
          Write-Host "ğŸš€ å‘å¸ƒä¿¡æ¯ï¼š"
          Write-Host "  - ç‰ˆæœ¬: $version"
          Write-Host "  - æ ‡ç­¾: $tag"
          Write-Host "  - é¢„å‘å¸ƒ: ${{ github.event.inputs.prerelease }}"
          Write-Host "  - è‰ç¨¿: ${{ github.event.inputs.draft }}"
          Write-Host "  - æ„å»ºå¹³å°: $($platforms -join ', ')"
          Write-Host ""
          Write-Host "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/$tag"