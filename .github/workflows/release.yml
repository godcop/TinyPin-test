name: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - "v*" # é€šé…ç¬¦åŒ¹é…ä»¥ "v" å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ã€v2.3.4ï¼‰
  # ä¹Ÿå¯ä»¥æ·»åŠ å…¶ä»–è§¦å‘æ¡ä»¶ï¼Œå¦‚æœéœ€è¦
  # pull_request:
  #   branches: [ main ]

# æ·»åŠ å¿…è¦çš„æƒé™è®¾ç½®
permissions:
  contents: write # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  actions: read # å…è®¸è¯»å– Actions çŠ¶æ€
  checks: read # å…è®¸è¯»å–æ£€æŸ¥çŠ¶æ€

env:
  # æ„å»ºé…ç½®
  BUILD_CONFIGURATION: Release
  # é¡¹ç›®åç§°
  PROJECT_NAME: TinyPin

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # - name: è·å–æ ‡ç­¾å
      #   id: get_tag
      #   run: |
      #     # github.ref æ ¼å¼ä¸º refs/tags/v1.0.0ï¼Œæå–æ ‡ç­¾åï¼ˆv1.0.0ï¼‰
      #     TAG_NAME="${{ github.ref_name }}"
      #     echo "æ£€æµ‹åˆ°æ ‡ç­¾ï¼š$TAG_NAME"
      #     echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT  # è¾“å‡ºåˆ°åç»­æ­¥éª¤ä½¿ç”¨

      - name: è®¾ç½®MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: pwsh
        run: |
          # ä»gitæ ‡ç­¾è·å–ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰æ ‡ç­¾åˆ™ä½¿ç”¨æ—¥æœŸ
          $tag = git describe --tags --abbrev=0 2>$null
          if ($tag) {
            $version = $tag -replace '^v', ''
          } else {
            $version = "1.0.$(Get-Date -Format 'yyyyMMdd')"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT
          echo "æ„å»ºç‰ˆæœ¬: $version"

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          mkdir -p build/compile/Release/x64
          mkdir -p build/compile/Release/Win32
          mkdir -p build/compile/Release/ARM64
          mkdir -p build/installer

      - name: æ„å»ºæ‰€æœ‰å¹³å°
        shell: pwsh
        run: |
          $platforms = @("x64", "Win32", "ARM64")

          foreach ($platform in $platforms) {
            Write-Host "ğŸ”¨ æ„å»º $platform ç‰ˆæœ¬..."
            msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=$platform /p:OutDir="build\compile\Release\$platform\" /nologo /verbosity:minimal
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform ç‰ˆæœ¬æ„å»ºå¤±è´¥"
              exit 1
            }
            
            $exePath = "build\compile\Release\$platform\TinyPin.exe"
            if (Test-Path $exePath) {
              $size = (Get-Item $exePath).Length
              Write-Host "âœ“ $platform ç‰ˆæœ¬æ„å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
            } else {
              Write-Error "$platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            }
          }

      - name: åˆ›å»ºæ‰€æœ‰å®‰è£…åŒ…
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $platforms = @("x64", "Win32", "arm64")
          $isccPath = "tools\InnoSetup6\ISCC.exe"
          $scriptPath = "tools\Scripts\TinyPin.iss"
          $outputDir = "build\installer"

          foreach ($platform in $platforms) {
            Write-Host "ğŸ“¦ åˆ›å»º $platform å®‰è£…åŒ…..."
            $sourcePath = "build\compile\Release\$platform\TinyPin.exe"
            # è½¬æ¢ä¸ºç›¸å¯¹äºè„šæœ¬æ–‡ä»¶çš„è·¯å¾„ï¼ˆè„šæœ¬åœ¨ tools\Scripts\ ç›®å½•ä¸‹ï¼‰
            $relativeSourcePath = "..\..\build\compile\Release\$platform\TinyPin.exe"
            
            if (!(Test-Path $sourcePath)) {
              Write-Error "æºæ–‡ä»¶ä¸å­˜åœ¨: $sourcePath"
              exit 1
            }
            
            # ä½¿ç”¨ç›¸å¯¹äºè„šæœ¬æ–‡ä»¶çš„è·¯å¾„ï¼Œè¾“å‡ºåˆ°è„šæœ¬ç›®å½•ä¸‹çš„ build\installer
            $scriptOutputDir = "build\installer"
            
            Write-Host "ğŸ”§ æ‰§è¡Œ Inno Setup ç¼–è¯‘:"
            Write-Host "  - å‘½ä»¤: $isccPath $scriptPath /Dp=$platform /Ds=$relativeSourcePath /Do=$scriptOutputDir /Dv=$version"
            
            & $isccPath $scriptPath /Dp=$platform /Ds=$relativeSourcePath /Do=$scriptOutputDir /Dv=$version
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥ Inno Setup å®é™…è¾“å‡ºçš„å®‰è£…åŒ…è·¯å¾„ï¼ˆåœ¨è„šæœ¬ç›®å½•ä¸‹ï¼‰
            # æ³¨æ„ï¼šå¦‚æœç‰ˆæœ¬å·æœªæ­£ç¡®ä¼ é€’ï¼ŒInno Setup å¯èƒ½ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬å· 1.0.0
            $possibleVersions = @($version, "1.0.0")
            $scriptInstallerPath = $null
            $actualVersion = $null
            
            foreach ($testVersion in $possibleVersions) {
              $testPath = "tools\Scripts\$scriptOutputDir\TinyPin-$testVersion-$platform-setup.exe"
              if (Test-Path $testPath) {
                $scriptInstallerPath = $testPath
                $actualVersion = $testVersion
                break
              }
            }
            
            $finalInstallerPath = "$outputDir\TinyPin-$version-$platform-setup.exe"
            
            if ($scriptInstallerPath -and (Test-Path $scriptInstallerPath)) {
              # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
              $targetDir = Split-Path $finalInstallerPath -Parent
              if (!(Test-Path $targetDir)) {
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
              }
              
              # ç§»åŠ¨å®‰è£…åŒ…åˆ°æœ€ç»ˆä½ç½®
              Write-Host "ğŸ“¦ ç§»åŠ¨å®‰è£…åŒ…: $scriptInstallerPath -> $finalInstallerPath"
              Move-Item -Path $scriptInstallerPath -Destination $finalInstallerPath -Force
              
              if (Test-Path $finalInstallerPath) {
                $size = (Get-Item $finalInstallerPath).Length
                Write-Host "âœ“ $platform å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
                if ($actualVersion -ne $version) {
                  Write-Host "  âš ï¸ æ³¨æ„: å®é™…ç‰ˆæœ¬å· ($actualVersion) ä¸æœŸæœ›ç‰ˆæœ¬å· ($version) ä¸åŒ¹é…"
                }
              } else {
                Write-Error "$platform å®‰è£…åŒ…ç§»åŠ¨å¤±è´¥"
                exit 1
              }
            } else {
              Write-Error "$platform å®‰è£…åŒ…æ–‡ä»¶æœªæ‰¾åˆ°"
              # åˆ—å‡ºè„šæœ¬è¾“å‡ºç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ç”¨äºè°ƒè¯•
              $scriptOutputFullPath = "tools\Scripts\$scriptOutputDir"
              if (Test-Path $scriptOutputFullPath) {
                Write-Host "è„šæœ¬è¾“å‡ºç›®å½•å†…å®¹:"
                Get-ChildItem $scriptOutputFullPath | ForEach-Object {
                  Write-Host "  ğŸ“„ $($_.Name)"
                }
              }
              exit 1
            }
          }

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $date = Get-Date -Format "yyyyå¹´MMæœˆddæ—¥"
          $tagName = "v$version"

          Write-Host "ğŸ“‹ ç”Ÿæˆå‘å¸ƒæ—¥å¿—..."
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          $previousTag = git describe --tags --abbrev=0 --match "v*" HEAD^ 2>$null
          if (-not $previousTag) {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰æäº¤è®°å½•"
            $previousTag = ""
          } else {
            Write-Host "ğŸ“Œ ä¸Šä¸€ä¸ªæ ‡ç­¾: $previousTag"
          }

          # è·å–è‡ªä¸Šä¸€ä¸ªæ ‡ç­¾ä»¥æ¥çš„æäº¤è®°å½•
          if ($previousTag) {
            $commitList = git log --pretty=format:"%s" "$previousTag..HEAD" 2>$null
          } else {
            $commitList = git log --pretty=format:"%s" 2>$null
          }

          if ($commitList) {
            # å°†æ¯ä¸ªæäº¤æ ‡é¢˜è½¬æ¢ä¸ºæ— åºåˆ—è¡¨æ ¼å¼
            $commits = ($commitList | ForEach-Object { "- $_" }) -join "`n"
          } else {
            $commits = "- æ— æ›´æ–°è¯´æ˜"
          }

          Write-Host "ğŸ“ æ‰¾åˆ°çš„æäº¤è®°å½•:"
          Write-Host $commits

          $releaseNotes = @"
          ## TinyPin $version å‘å¸ƒ

          **å‘å¸ƒæ—¥æœŸ**: $date
          **æ ‡ç­¾**: $tagName

          ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

          - **TinyPin-$version-x64-setup.exe** - é€‚ç”¨äº 64 ä½ Windows ç³»ç»Ÿ
          - **TinyPin-$version-Win32-setup.exe** - é€‚ç”¨äº 32 ä½å’Œ 64 ä½ Windows ç³»ç»Ÿ
          - **TinyPin-$version-arm64-setup.exe** - é€‚ç”¨äº ARM64 Windows ç³»ç»Ÿ

          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚

          - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - å¯¹åº”çš„ç³»ç»Ÿæ¶æ„ (x64/x86/ARM64)

          ### ğŸ“ æ›´æ–°å†…å®¹

          $commits

          ### ğŸš€ å®‰è£…è¯´æ˜

          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
          2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
          3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æ‰¾åˆ° TinyPin

          ---

          **å®Œæ•´æ›´æ”¹æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$tagName...${{ github.ref_name }}
          "@

          # å°†å‘å¸ƒè¯´æ˜ä¿å­˜åˆ°æ–‡ä»¶
          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
          echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT

      - name: æ£€æŸ¥ GitHub Release å‰ç½®æ¡ä»¶
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tagName = "v$version"

          Write-Host "ğŸ” æ£€æŸ¥ GitHub Release å‰ç½®æ¡ä»¶..."
          Write-Host "  - ç‰ˆæœ¬å·: $version"
          Write-Host "  - æ ‡ç­¾å: $tagName"
          Write-Host "  - ä»“åº“: ${{ github.repository }}"
          Write-Host "  - é¢„å‘å¸ƒ: false"

          # æ£€æŸ¥æ‰€æœ‰å¹³å°çš„å®‰è£…åŒ…æ˜¯å¦å­˜åœ¨
          $platforms = @("x64", "Win32", "arm64")
          $allFilesExist = $true

          foreach ($platform in $platforms) {
            $installerPath = "build\installer\TinyPin-$version-$platform-setup.exe"
            if (Test-Path $installerPath) {
              $size = (Get-Item $installerPath).Length
              Write-Host "  âœ“ $platform å®‰è£…åŒ…å­˜åœ¨ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
            } else {
              Write-Host "  âœ— $platform å®‰è£…åŒ…ä¸å­˜åœ¨: $installerPath"
              $allFilesExist = $false
            }
          }

          if (-not $allFilesExist) {
            Write-Error "éƒ¨åˆ†å®‰è£…åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º Release"
            exit 1
          }

          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          try {
            $existingTags = git tag -l $tagName
            if ($existingTags) {
              Write-Host "âš ï¸ æ ‡ç­¾ $tagName å·²å­˜åœ¨"
              Write-Host "ç°æœ‰æ ‡ç­¾åˆ—è¡¨:"
              git tag -l | ForEach-Object { Write-Host "  - $_" }
              Write-Host ""
              Write-Host "è§£å†³æ–¹æ¡ˆ:"
              Write-Host "  1. ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬å·"
              Write-Host "  2. åˆ é™¤ç°æœ‰æ ‡ç­¾: git tag -d $tagName && git push origin :refs/tags/$tagName"
              Write-Host "  3. è®¾ç½® draft: true åˆ›å»ºè‰ç¨¿ Release"
              Write-Error "æ ‡ç­¾å·²å­˜åœ¨ï¼Œåœæ­¢åˆ›å»º Release"
              exit 1
            } else {
              Write-Host "âœ“ æ ‡ç­¾ $tagName ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
            }
          } catch {
            Write-Host "âš ï¸ æ— æ³•æ£€æŸ¥æ ‡ç­¾çŠ¶æ€: $($_.Exception.Message)"
          }

          Write-Host "âœ… æ‰€æœ‰å‰ç½®æ¡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: åˆ›å»º GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: TinyPin v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            build/installer/*.exe
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: GitHub Release åˆ›å»ºç»“æœ
        if: always() && (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        shell: pwsh
        run: |
          if ("${{ steps.create_release.outcome }}" -eq "success") {
            Write-Host "ğŸ‰ GitHub Release åˆ›å»ºæˆåŠŸ!"
            Write-Host "  - Release URL: ${{ steps.create_release.outputs.url }}"
            Write-Host "  - ä¸Šä¼ çš„æ–‡ä»¶:"
            Get-ChildItem "build\installer\*.exe" | ForEach-Object {
              $size = [math]::Round($_.Length/1MB, 2)
              Write-Host "    ğŸ“¦ $($_.Name) ($size MB)"
            }
          } else {
            Write-Host "âŒ GitHub Release åˆ›å»ºå¤±è´¥"
            Write-Host "å¯èƒ½çš„åŸå› :"
            Write-Host "  1. æƒé™é—®é¢˜ - æ£€æŸ¥ GITHUB_TOKEN æƒé™"
            Write-Host "  2. æ ‡ç­¾å·²å­˜åœ¨ - ä½¿ç”¨ä¸åŒç‰ˆæœ¬å·æˆ–åˆ é™¤ç°æœ‰æ ‡ç­¾"
            Write-Host "  3. æ–‡ä»¶ä¸å­˜åœ¨ - æ£€æŸ¥å®‰è£…åŒ…æ˜¯å¦æ­£ç¡®åˆ›å»º"
            Write-Host "  4. ç½‘ç»œé—®é¢˜ - é‡è¯•å‘å¸ƒæµç¨‹"
            Write-Host ""
            Write-Host "è°ƒè¯•ä¿¡æ¯:"
            Write-Host "  - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
            Write-Host "  - æ ‡ç­¾: v${{ steps.version.outputs.version }}"
            Write-Host "  - ä»“åº“: ${{ github.repository }}"
            Write-Host "  - åˆ†æ”¯: ${{ github.ref }}"
            Write-Host ""
            Write-Host "å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œè¯·ç¡®ä¿:"
            Write-Host "  1. ä»“åº“è®¾ç½® > Actions > General > Workflow permissions è®¾ç½®ä¸º 'Read and write permissions'"
            Write-Host "  2. æˆ–è€…åœ¨ä»“åº“è®¾ç½®ä¸­åˆ›å»ºå…·æœ‰ 'contents:write' æƒé™çš„ Personal Access Token"
          }

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: TinyPin-${{ steps.version.outputs.version }}-Installers
          path: |
            build/installer/*.exe
          retention-days: 30

      - name: æ„å»ºå®Œæˆé€šçŸ¥
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          Write-Host "ğŸ‰ TinyPin $version æ„å»ºå®Œæˆï¼"
          Write-Host ""
          Write-Host "ğŸ“¦ ç”Ÿæˆçš„å®‰è£…åŒ…ï¼š"
          Get-ChildItem "build\installer\*.exe" | ForEach-Object {
            $size = [math]::Round($_.Length/1MB, 2)
            Write-Host "  - $($_.Name) ($size MB)"
          }

          if ("${{ github.event_name }}" -eq "push" -and "${{ startsWith(github.ref, 'refs/tags/') }}") {
            Write-Host ""
            Write-Host "ğŸš€ å·²è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releases: ${{ steps.version.outputs.tag }}"
            Write-Host "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          }
