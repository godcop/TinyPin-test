name: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read
  checks: read

env:
  BUILD_CONFIGURATION: Release
  PROJECT_NAME: TinyPin

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: pwsh
        run: |
          $tag = git describe --tags --abbrev=0 2>$null
          if ($tag) {
            $version = $tag -replace '^v', ''
          } else {
            $version = "1.0.$(Get-Date -Format 'yyyyMMdd')"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          mkdir -p build/compile/Release/x64
          mkdir -p build/compile/Release/Win32
          mkdir -p build/compile/Release/ARM64
          mkdir -p build/installer

      - name: æ„å»ºæ‰€æœ‰å¹³å°
        shell: pwsh
        run: |
          $platforms = @("x64", "Win32", "ARM64")
          foreach ($platform in $platforms) {
            msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=$platform /p:OutDir="build\compile\Release\$platform\" /nologo /verbosity:minimal
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform ç‰ˆæœ¬æ„å»ºå¤±è´¥"
              exit 1
            }
            if (!(Test-Path "build\compile\Release\$platform\TinyPin.exe")) {
              Write-Error "$platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            }
          }

      - name: åˆ›å»ºå®‰è£…åŒ…
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $platforms = @("x64", "Win32", "arm64")
          $isccPath = "tools\InnoSetup6\ISCC.exe"
          $scriptPath = "tools\Scripts\TinyPin.iss"
          $outputDir = "build\installer"

          foreach ($platform in $platforms) {
            $sourcePath = "build\compile\Release\$platform\TinyPin.exe"
            $relativeSourcePath = "..\..\build\compile\Release\$platform\TinyPin.exe"
            
            if (!(Test-Path $sourcePath)) {
              Write-Error "æºæ–‡ä»¶ä¸å­˜åœ¨: $sourcePath"
              exit 1
            }
            
            $scriptOutputDir = "build\installer"
            & $isccPath $scriptPath /Dp=$platform /Ds=$relativeSourcePath /Do=$scriptOutputDir /Dv=$version
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "$platform å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
              exit 1
            }
            
            # ç§»åŠ¨å®‰è£…åŒ…åˆ°æœ€ç»ˆä½ç½®
            $possibleVersions = @($version, "1.0.0")
            $scriptInstallerPath = $null
            
            foreach ($testVersion in $possibleVersions) {
              $testPath = "tools\Scripts\$scriptOutputDir\TinyPin-$testVersion-$platform-setup.exe"
              if (Test-Path $testPath) {
                $scriptInstallerPath = $testPath
                break
              }
            }
            
            $finalInstallerPath = "$outputDir\TinyPin-$version-$platform-setup.exe"
            
            if ($scriptInstallerPath -and (Test-Path $scriptInstallerPath)) {
              $targetDir = Split-Path $finalInstallerPath -Parent
              if (!(Test-Path $targetDir)) {
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
              }
              Move-Item -Path $scriptInstallerPath -Destination $finalInstallerPath -Force
              
              if (!(Test-Path $finalInstallerPath)) {
                Write-Error "$platform å®‰è£…åŒ…ç§»åŠ¨å¤±è´¥"
                exit 1
              }
            } else {
              Write-Error "$platform å®‰è£…åŒ…æ–‡ä»¶æœªæ‰¾åˆ°"
              exit 1
            }
          }

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $date = Get-Date -Format "yyyyå¹´MMæœˆddæ—¥"
          $tagName = "v$version"

          # è·å–æäº¤è®°å½•
          $previousTag = git describe --tags --abbrev=0 --match "v*" HEAD^ 2>$null
          if ($previousTag) {
            $commitList = git log --pretty=format:"%s" "$previousTag..HEAD" 2>$null
          } else {
            $commitList = git log --pretty=format:"%s" 2>$null
          }

          if ($commitList) {
            $commits = ($commitList | ForEach-Object { "- $_" }) -join "`n"
          } else {
            $commits = "- æ— æ›´æ–°è¯´æ˜"
          }

          $releaseNotes = @"
## TinyPin $version å‘å¸ƒ

**å‘å¸ƒæ—¥æœŸ**: $date
**æ ‡ç­¾**: $tagName

### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

- **TinyPin-$version-x64-setup.exe** - é€‚ç”¨äº 64 ä½ Windows ç³»ç»Ÿ
- **TinyPin-$version-Win32-setup.exe** - é€‚ç”¨äº 32 ä½å’Œ 64 ä½ Windows ç³»ç»Ÿ
- **TinyPin-$version-arm64-setup.exe** - é€‚ç”¨äº ARM64 Windows ç³»ç»Ÿ

### ğŸ”§ ç³»ç»Ÿè¦æ±‚

- Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
- å¯¹åº”çš„ç³»ç»Ÿæ¶æ„ (x64/x86/ARM64)

### ğŸ“ æ›´æ–°å†…å®¹

$commits

### ğŸš€ å®‰è£…è¯´æ˜

1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æ‰¾åˆ° TinyPin
"@

          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
          echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT

      - name: éªŒè¯å®‰è£…åŒ…
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $platforms = @("x64", "Win32", "arm64")
          $allFilesExist = $true

          foreach ($platform in $platforms) {
            $installerPath = "build\installer\TinyPin-$version-$platform-setup.exe"
            if (!(Test-Path $installerPath)) {
              Write-Error "$platform å®‰è£…åŒ…ä¸å­˜åœ¨: $installerPath"
              $allFilesExist = $false
            }
          }

          if (-not $allFilesExist) {
            Write-Error "éƒ¨åˆ†å®‰è£…åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º Release"
            exit 1
          }

      - name: åˆ›å»º GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: TinyPin v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            build/installer/*.exe
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: TinyPin-${{ steps.version.outputs.version }}-Installers
          path: |
            build/installer/*.exe
          retention-days: 30
